"use strict";

var _babelHelpers = require("babel-runtime/helpers")["default"];

var _core = require("babel-runtime/core-js")["default"];

var _require = require("../helpers/utils");

var uniqueId = _require.uniqueId;
var accessors = _require.accessors;

var _require2 = require("../core/layer");

var Layer = _require2.Layer;

var Label = (function (Layer) {
  function Label() {
    _babelHelpers.classCallCheck(this, Label);

    _babelHelpers.get(_core.Object.getPrototypeOf(Label.prototype), "constructor", this).call(this);

    var defaults = {
      type: "label",
      // expose to allow tweaking vertical alignment for design adjustments
      verticalAlignment: { top: "1em", middle: "0.5em", bottom: "0" }
    };

    this.params(defaults);

    // data accessors
    this.y(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.y || 0;
      }
      d.y = +v;
    });

    this.x(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.x || 0;
      }
      d.x = +v;
    });

    this.text(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.text + "";
      }
      d.text = v + "";
    });

    this.bgColor(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.bgColor + "";
      }
      d.bgColor = v + "";
    });

    // the following can also be setted as global params
    // which are acting as default values
    this.width(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.width;
      }
      d.width = +v;
    });

    this.height(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.height;
      }
      d.height = +v;
    });

    this.color(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.color || "#000000";
      }
      d.color = v + "";
    });

    // 'left', 'center', 'top'
    this.align(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.align || "left";
      }
      d.align = v + "";
    });

    // 'top', 'middle', 'bottom'
    this.valign(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.valign || "top";
      }
      d.valign = v + "";
    });

    this.margin({ top: 0, right: 0, bottom: 0, left: 0 });
  }

  _babelHelpers.inherits(Label, Layer);

  _babelHelpers.prototypeProperties(Label, null, {
    xZoom: {
      value: function xZoom(factor) {
        this.draw();
      },
      writable: true,
      configurable: true
    },
    update: {
      value: function update(data) {
        _babelHelpers.get(_core.Object.getPrototypeOf(Label.prototype), "update", this).call(this, data);

        this.items = this.g.selectAll("." + this.param("unitClass")).data(this.data(), this.sortIndex());

        var sel = this.items.enter().append("g").classed("item", true).classed(this.param("unitClass"), true);

        sel.append("rect").attr("class", "bounding-box").attr("fill", "transparent");

        sel.append("text").attr("class", "text");

        this.items.exit().remove();
      },
      writable: true,
      configurable: true
    },
    draw: {
      value: function draw() {
        var _this = this;

        var el = arguments[0] === undefined ? null : arguments[0];

        el = el || this.items;

        var _xScale = this.base.xScale;
        var _yScale = this.yScale;

        var _w = this.width();
        var _h = this.height();
        var _x = this.x();
        var _y = this.y();
        var _align = this.align();
        var _valign = this.valign();
        var _margin = this.margin();
        var _verticalAlignment = this.params().verticalAlignment;
        var minDomain = _xScale.domain()[0];

        // scales for bounding box position
        var w = function (d) {
          var width = _xScale(minDomain + _w(d));
          return width < 0 ? 0 : width;
        };

        var x = function (d) {
          return _xScale(_x(d));
        };

        var h = function (d) {
          return _this.param("height") - _yScale(_h(d)) || _this.param("height");
        };

        var y = function (d) {
          return _yScale(_y(d)) - h(d) || 0;
        };

        // scales for text-position
        var tx = function (d) {
          var ret;
          switch (_align(d)) {
            case "left":
              ret = x(d) + parseInt(_margin().left, 10);
              break;
            case "center":
              ret = x(d) + w(d) / 2;
              break;
            case "right":
              ret = x(d) + w(d) - parseInt(_margin().right, 10);
              break;
          }

          return ret;
        };

        var anchor = function (d) {
          var ret;
          switch (_align(d)) {
            case "left":
              ret = "start";
              break;
            case "center":
              ret = "middle";
              break;
            case "right":
              ret = "end";
              break;
          }

          return ret;
        };

        var ty = function (d) {
          var ret;
          switch (_valign(d)) {
            case "top":
              ret = y(d) + parseInt(_margin().top, 10);
              break;
            case "middle":
              ret = y(d) + h(d) / 2;
              break;
            case "bottom":
              ret = y(d) + h(d) - parseInt(_margin().bottom, 10);
              break;
          }

          return ret;
        };

        // based on small manual testing - can probably be improved
        var dy = function (d) {
          var ret;
          switch (_valign(d)) {
            case "top":
              ret = _verticalAlignment.top;
              break;
            case "middle":
              ret = _verticalAlignment.middle;
              break;
            case "bottom":
              ret = _verticalAlignment.bottom;
              break;
          }

          return ret;
        };

        el.selectAll(".bounding-box").attr("x", x).attr("y", y).attr("width", w).attr("height", h).attr("fill", function (d) {
          return _this.bgColor()(d);
        });

        el.selectAll(".text").text(function (d) {
          return _this.text()(d);
        }).attr("fill", function (d) {
          return _this.color()(d);
        }).attr("x", tx).attr("y", ty).attr("dy", dy).attr("text-anchor", anchor);

        if (!!this.each()) {
          el.each(this.each());
        }
      },
      writable: true,
      configurable: true
    }
  });

  return Label;
})(Layer);

accessors.getFunction(Label.prototype, ["x", "y", "width", "height", "text", "color", "align", "valign", "margin", "sortIndex", "bgColor"]);

function factory() {
  return new Label();
}
factory.Label = Label;

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,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JztcblxudmFyIHsgdW5pcXVlSWQsIGFjY2Vzc29ycyB9ID0gcmVxdWlyZSgnLi4vaGVscGVycy91dGlscycpO1xudmFyIHsgTGF5ZXIgfSA9IHJlcXVpcmUoJy4uL2NvcmUvbGF5ZXInKTtcblxuY2xhc3MgTGFiZWwgZXh0ZW5kcyBMYXllciB7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgIHR5cGU6ICdsYWJlbCcsXG4gICAgICAvLyBleHBvc2UgdG8gYWxsb3cgdHdlYWtpbmcgdmVydGljYWwgYWxpZ25tZW50IGZvciBkZXNpZ24gYWRqdXN0bWVudHNcbiAgICAgIHZlcnRpY2FsQWxpZ25tZW50OiB7IHRvcDogJzFlbScsIG1pZGRsZTogJzAuNWVtJywgYm90dG9tOiAnMCcgfVxuICAgIH07XG5cbiAgICB0aGlzLnBhcmFtcyhkZWZhdWx0cyk7XG5cbiAgICAvLyBkYXRhIGFjY2Vzc29yc1xuICAgIHRoaXMueShmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuICtkLnkgfHwgMDsgfVxuICAgICAgZC55ID0gKCt2KTtcbiAgICB9KTtcblxuICAgIHRoaXMueChmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuICtkLnggfHwgMDsgfVxuICAgICAgZC54ID0gKCt2KTtcbiAgICB9KTtcblxuICAgIHRoaXMudGV4dChmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuIChkLnRleHQgKyAnJyk7IH1cbiAgICAgIGQudGV4dCA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5iZ0NvbG9yKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gZC5iZ0NvbG9yICsgJyc7IH1cbiAgICAgIGQuYmdDb2xvciA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgLy8gdGhlIGZvbGxvd2luZyBjYW4gYWxzbyBiZSBzZXR0ZWQgYXMgZ2xvYmFsIHBhcmFtc1xuICAgIC8vIHdoaWNoIGFyZSBhY3RpbmcgYXMgZGVmYXVsdCB2YWx1ZXNcbiAgICB0aGlzLndpZHRoKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gK2Qud2lkdGg7IH1cbiAgICAgIGQud2lkdGggPSAoK3YpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5oZWlnaHQoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSB7IHJldHVybiArZC5oZWlnaHQ7IH1cbiAgICAgIGQuaGVpZ2h0ID0gKCt2KTtcbiAgICB9KTtcblxuICAgIHRoaXMuY29sb3IoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSB7IHJldHVybiBkLmNvbG9yIHx8wqAnIzAwMDAwMCc7IH1cbiAgICAgIGQuY29sb3IgPSAodiArICcnKTtcbiAgICB9KTtcblxuICAgIC8vICdsZWZ0JywgJ2NlbnRlcicsICd0b3AnXG4gICAgdGhpcy5hbGlnbihmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuIGQuYWxpZ24gfHzCoCdsZWZ0JzsgfVxuICAgICAgZC5hbGlnbiA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgLy8gJ3RvcCcsICdtaWRkbGUnLCAnYm90dG9tJ1xuICAgIHRoaXMudmFsaWduKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gZC52YWxpZ24gfHzCoCd0b3AnOyB9XG4gICAgICBkLnZhbGlnbiA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5tYXJnaW4oeyB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAsIGxlZnQ6IDAgfSk7XG4gIH1cblxuICB4Wm9vbShmYWN0b3IpIHtcbiAgICB0aGlzLmRyYXcoKTtcbiAgfVxuXG4gIHVwZGF0ZShkYXRhKSB7XG4gICAgc3VwZXIudXBkYXRlKGRhdGEpO1xuXG4gICAgdGhpcy5pdGVtcyA9IHRoaXMuZy5zZWxlY3RBbGwoJy4nICsgdGhpcy5wYXJhbSgndW5pdENsYXNzJykpXG4gICAgICAuZGF0YSh0aGlzLmRhdGEoKSwgdGhpcy5zb3J0SW5kZXgoKSk7XG5cbiAgICB2YXIgc2VsID0gdGhpcy5pdGVtcy5lbnRlcigpXG4gICAgICAuYXBwZW5kKCdnJylcbiAgICAgIC5jbGFzc2VkKCdpdGVtJywgdHJ1ZSlcbiAgICAgIC5jbGFzc2VkKHRoaXMucGFyYW0oJ3VuaXRDbGFzcycpLCB0cnVlKTtcblxuICAgIHNlbC5hcHBlbmQoJ3JlY3QnKVxuICAgICAgLmF0dHIoJ2NsYXNzJywgJ2JvdW5kaW5nLWJveCcpXG4gICAgICAuYXR0cignZmlsbCcsICd0cmFuc3BhcmVudCcpO1xuXG4gICAgc2VsLmFwcGVuZCgndGV4dCcpXG4gICAgIC5hdHRyKCdjbGFzcycsICd0ZXh0Jyk7XG5cbiAgICB0aGlzLml0ZW1zLmV4aXQoKS5yZW1vdmUoKTtcbiAgfVxuXG4gIGRyYXcoZWwgPSBudWxsKSB7XG4gICAgZWwgPSBlbCB8fCB0aGlzLml0ZW1zO1xuXG4gICAgdmFyIF94U2NhbGUgPSB0aGlzLmJhc2UueFNjYWxlO1xuICAgIHZhciBfeVNjYWxlID0gdGhpcy55U2NhbGU7XG5cbiAgICB2YXIgX3cgPSB0aGlzLndpZHRoKCk7XG4gICAgdmFyIF9oID0gdGhpcy5oZWlnaHQoKTtcbiAgICB2YXIgX3ggPSB0aGlzLngoKTtcbiAgICB2YXIgX3kgPSB0aGlzLnkoKTtcbiAgICB2YXIgX2FsaWduICA9IHRoaXMuYWxpZ24oKTtcbiAgICB2YXIgX3ZhbGlnbiA9IHRoaXMudmFsaWduKCk7XG4gICAgdmFyIF9tYXJnaW4gPSB0aGlzLm1hcmdpbigpO1xuICAgIHZhciBfdmVydGljYWxBbGlnbm1lbnQgPSB0aGlzLnBhcmFtcygpLnZlcnRpY2FsQWxpZ25tZW50O1xuICAgIHZhciBtaW5Eb21haW4gPSBfeFNjYWxlLmRvbWFpbigpWzBdO1xuXG4gICAgLy8gc2NhbGVzIGZvciBib3VuZGluZyBib3ggcG9zaXRpb25cbiAgICB2YXIgdyA9IChkKSA9PiB7XG4gICAgICB2YXIgd2lkdGggPSBfeFNjYWxlKG1pbkRvbWFpbiArIF93KGQpKTtcbiAgICAgIHJldHVybiB3aWR0aCA8IDAgPyAwIDogd2lkdGg7XG4gICAgfTtcblxuICAgIHZhciB4ID0gKGQpID0+IHtcbiAgICAgIHJldHVybiBfeFNjYWxlKF94KGQpKTtcbiAgICB9O1xuXG4gICAgdmFyIGggPSAoZCkgPT4ge1xuICAgICAgcmV0dXJuICh0aGlzLnBhcmFtKCdoZWlnaHQnKSAtIF95U2NhbGUoX2goZCkpKSB8fCB0aGlzLnBhcmFtKCdoZWlnaHQnKTtcbiAgICB9O1xuXG4gICAgdmFyIHkgPSAoZCkgPT4ge1xuICAgICAgcmV0dXJuIChfeVNjYWxlKF95KGQpKSAtIGgoZCkpIHx8IDA7XG4gICAgfTtcblxuICAgIC8vIHNjYWxlcyBmb3IgdGV4dC1wb3NpdGlvblxuICAgIHZhciB0eCA9IChkKSA9PiB7XG4gICAgICB2YXIgcmV0O1xuICAgICAgc3dpdGNoIChfYWxpZ24oZCkpIHtcbiAgICAgICAgY2FzZSAnbGVmdCc6XG4gICAgICAgICAgcmV0ID0geChkKSArIHBhcnNlSW50KF9tYXJnaW4oKS5sZWZ0LCAxMCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2NlbnRlcic6XG4gICAgICAgICAgcmV0ID0geChkKSArICh3KGQpIC8gMik7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3JpZ2h0JzpcbiAgICAgICAgICByZXQgPSB4KGQpICsgdyhkKSAtIHBhcnNlSW50KF9tYXJnaW4oKS5yaWdodCwgMTApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmV0O1xuICAgIH07XG5cbiAgICB2YXIgYW5jaG9yID0gKGQpID0+IHtcbiAgICAgIHZhciByZXQ7XG4gICAgICBzd2l0Y2ggKF9hbGlnbihkKSkge1xuICAgICAgICBjYXNlICdsZWZ0JzpcbiAgICAgICAgICByZXQgPSAnc3RhcnQnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdjZW50ZXInOlxuICAgICAgICAgIHJldCA9ICdtaWRkbGUnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdyaWdodCc6XG4gICAgICAgICAgcmV0ID0gJ2VuZCc7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcblxuICAgIHZhciB0eSA9IChkKSA9PiB7XG4gICAgICB2YXIgcmV0O1xuICAgICAgc3dpdGNoIChfdmFsaWduKGQpKSB7XG4gICAgICAgIGNhc2UgJ3RvcCc6XG4gICAgICAgICAgcmV0ID0geShkKSArIHBhcnNlSW50KF9tYXJnaW4oKS50b3AsIDEwKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnbWlkZGxlJzpcbiAgICAgICAgICByZXQgPSB5KGQpICsgKGgoZCkgLyAyKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnYm90dG9tJzpcbiAgICAgICAgICByZXQgPSB5KGQpICsgaChkKSAtIHBhcnNlSW50KF9tYXJnaW4oKS5ib3R0b20sIDEwKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuXG4gICAgLy8gYmFzZWQgb24gc21hbGwgbWFudWFsIHRlc3RpbmcgLSBjYW4gcHJvYmFibHkgYmUgaW1wcm92ZWRcbiAgICB2YXIgZHkgPSAoZCkgPT4ge1xuICAgICAgdmFyIHJldDtcbiAgICAgIHN3aXRjaCAoX3ZhbGlnbihkKSkge1xuICAgICAgICBjYXNlICd0b3AnOlxuICAgICAgICAgIHJldCA9IF92ZXJ0aWNhbEFsaWdubWVudC50b3A7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ21pZGRsZSc6XG4gICAgICAgICAgcmV0ID0gX3ZlcnRpY2FsQWxpZ25tZW50Lm1pZGRsZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnYm90dG9tJzpcbiAgICAgICAgICByZXQgPSBfdmVydGljYWxBbGlnbm1lbnQuYm90dG9tO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmV0O1xuICAgIH07XG5cbiAgICBlbC5zZWxlY3RBbGwoJy5ib3VuZGluZy1ib3gnKVxuICAgICAgLmF0dHIoJ3gnLCB4KVxuICAgICAgLmF0dHIoJ3knLCB5KVxuICAgICAgLmF0dHIoJ3dpZHRoJywgdylcbiAgICAgIC5hdHRyKCdoZWlnaHQnLCBoKVxuICAgICAgLmF0dHIoJ2ZpbGwnLCAoZCkgPT4geyByZXR1cm4gdGhpcy5iZ0NvbG9yKCkoZCk7IH0pO1xuXG4gICAgZWwuc2VsZWN0QWxsKCcudGV4dCcpXG4gICAgICAudGV4dCgoZCkgPT4geyByZXR1cm4gdGhpcy50ZXh0KCkoZCk7IH0pXG4gICAgICAuYXR0cignZmlsbCcsIChkKSA9PiB7IHJldHVybiB0aGlzLmNvbG9yKCkoZCk7IH0pXG4gICAgICAuYXR0cigneCcsIHR4KVxuICAgICAgLmF0dHIoJ3knLCB0eSlcbiAgICAgIC5hdHRyKCdkeScsIGR5KVxuICAgICAgLmF0dHIoJ3RleHQtYW5jaG9yJywgYW5jaG9yKTtcblxuICAgIGlmICghIXRoaXMuZWFjaCgpKSB7IGVsLmVhY2godGhpcy5lYWNoKCkpOyB9XG4gIH1cbn1cblxuYWNjZXNzb3JzLmdldEZ1bmN0aW9uKExhYmVsLnByb3RvdHlwZSxbXG4gICd4JywgJ3knLCAnd2lkdGgnLCAnaGVpZ2h0JywgJ3RleHQnLFxuICAnY29sb3InLCAnYWxpZ24nLCAndmFsaWduJywgJ21hcmdpbicsXG4gICdzb3J0SW5kZXgnLCAnYmdDb2xvcidcbl0pO1xuXG5mdW5jdGlvbiBmYWN0b3J5KCkgeyByZXR1cm4gbmV3IExhYmVsKCk7IH1cbmZhY3RvcnkuTGFiZWwgPSBMYWJlbDtcblxubW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5O1xuIl19