"use strict";

var _classCallCheck = require("babel-runtime/helpers/class-call-check")["default"];

var _inherits = require("babel-runtime/helpers/inherits")["default"];

var _get = require("babel-runtime/helpers/get")["default"];

var _createClass = require("babel-runtime/helpers/create-class")["default"];

var _core = require("babel-runtime/core-js")["default"];

var _require = require("../helpers/utils");

var uniqueId = _require.uniqueId;
var accessors = _require.accessors;

var _require2 = require("../core/layer");

var Layer = _require2.Layer;

var Label = (function (_Layer) {
  function Label() {
    _classCallCheck(this, Label);

    _get(_core.Object.getPrototypeOf(Label.prototype), "constructor", this).call(this);

    var defaults = {
      type: "label",
      // expose to allow tweaking vertical alignment for design adjustments
      verticalAlignment: { top: "1em", middle: "0.5em", bottom: "0" }
    };

    this.params(defaults);

    // data accessors
    this.y(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.y || 0;
      }
      d.y = +v;
    });

    this.x(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.x || 0;
      }
      d.x = +v;
    });

    this.text(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.text + "";
      }
      d.text = v + "";
    });

    this.bgColor(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.bgColor + "";
      }
      d.bgColor = v + "";
    });

    // the following can also be setted as global params
    // which are acting as default values
    this.width(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.width;
      }
      d.width = +v;
    });

    this.height(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.height;
      }
      d.height = +v;
    });

    this.color(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.color || "#000000";
      }
      d.color = v + "";
    });

    // 'left', 'center', 'top'
    this.align(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.align || "left";
      }
      d.align = v + "";
    });

    // 'top', 'middle', 'bottom'
    this.valign(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.valign || "top";
      }
      d.valign = v + "";
    });

    this.margin({ top: 0, right: 0, bottom: 0, left: 0 });
  }

  _inherits(Label, _Layer);

  _createClass(Label, {
    xZoom: {
      value: function xZoom(factor) {
        this.draw();
      }
    },
    update: {
      value: function update(data) {
        _get(_core.Object.getPrototypeOf(Label.prototype), "update", this).call(this, data);

        this.items = this.g.selectAll("." + this.param("unitClass")).data(this.data(), this.sortIndex());

        var sel = this.items.enter().append("g").classed("item", true).classed(this.param("unitClass"), true);

        sel.append("rect").attr("class", "bounding-box").attr("fill", "transparent");

        sel.append("text").attr("class", "text");

        this.items.exit().remove();
      }
    },
    draw: {
      value: function draw() {
        var _this = this;

        var el = arguments[0] === undefined ? null : arguments[0];

        el = el || this.items;

        var _xScale = this.base.xScale;
        var _yScale = this.yScale;

        var _w = this.width();
        var _h = this.height();
        var _x = this.x();
        var _y = this.y();
        var _align = this.align();
        var _valign = this.valign();
        var _margin = this.margin();
        var _verticalAlignment = this.params().verticalAlignment;
        var minDomain = _xScale.domain()[0];

        // scales for bounding box position
        var w = function (d) {
          var width = _xScale(minDomain + _w(d));
          return width < 0 ? 0 : width;
        };

        var x = function (d) {
          return _xScale(_x(d));
        };

        var h = function (d) {
          return _this.param("height") - _yScale(_h(d)) || _this.param("height");
        };

        var y = function (d) {
          return _yScale(_y(d)) - h(d) || 0;
        };

        // scales for text-position
        var tx = function (d) {
          var ret;
          switch (_align(d)) {
            case "left":
              ret = x(d) + parseInt(_margin().left, 10);
              break;
            case "center":
              ret = x(d) + w(d) / 2;
              break;
            case "right":
              ret = x(d) + w(d) - parseInt(_margin().right, 10);
              break;
          }

          return ret;
        };

        var anchor = function (d) {
          var ret;
          switch (_align(d)) {
            case "left":
              ret = "start";
              break;
            case "center":
              ret = "middle";
              break;
            case "right":
              ret = "end";
              break;
          }

          return ret;
        };

        var ty = function (d) {
          var ret;
          switch (_valign(d)) {
            case "top":
              ret = y(d) + parseInt(_margin().top, 10);
              break;
            case "middle":
              ret = y(d) + h(d) / 2;
              break;
            case "bottom":
              ret = y(d) + h(d) - parseInt(_margin().bottom, 10);
              break;
          }

          return ret;
        };

        // based on small manual testing - can probably be improved
        var dy = function (d) {
          var ret;
          switch (_valign(d)) {
            case "top":
              ret = _verticalAlignment.top;
              break;
            case "middle":
              ret = _verticalAlignment.middle;
              break;
            case "bottom":
              ret = _verticalAlignment.bottom;
              break;
          }

          return ret;
        };

        el.selectAll(".bounding-box").attr("x", x).attr("y", y).attr("width", w).attr("height", h).attr("fill", function (d) {
          return _this.bgColor()(d);
        });

        el.selectAll(".text").text(function (d) {
          return _this.text()(d);
        }).attr("fill", function (d) {
          return _this.color()(d);
        }).attr("x", tx).attr("y", ty).attr("dy", dy).attr("text-anchor", anchor);

        if (!!this.each()) {
          el.each(this.each());
        }
      }
    }
  });

  return Label;
})(Layer);

accessors.getFunction(Label.prototype, ["x", "y", "width", "height", "text", "color", "align", "valign", "margin", "sortIndex", "bgColor"]);

function factory() {
  return new Label();
}
factory.Label = Label;

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVzNi9oZWxwZXJzL3pvb21lci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7ZUFFOEIsT0FBTyxDQUFDLGtCQUFrQixDQUFDOztJQUFuRCxRQUFRLFlBQVIsUUFBUTtJQUFFLFNBQVMsWUFBVCxTQUFTOztnQkFDVCxPQUFPLENBQUMsZUFBZSxDQUFDOztJQUFsQyxLQUFLLGFBQUwsS0FBSzs7SUFFTCxLQUFLO0FBRUUsV0FGUCxLQUFLLEdBRUs7MEJBRlYsS0FBSzs7QUFHUCxxQ0FIRSxLQUFLLDZDQUdDOztBQUVSLFFBQUksUUFBUSxHQUFHO0FBQ2IsVUFBSSxFQUFFLE9BQU87O0FBRWIsdUJBQWlCLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRTtLQUNoRSxDQUFDOztBQUVGLFFBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7OztBQUd0QixRQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVMsQ0FBQyxFQUFZO1VBQVYsQ0FBQyxnQ0FBRyxJQUFJOztBQUN6QixVQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7QUFBRSxlQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7T0FBRTtBQUNyQyxPQUFDLENBQUMsQ0FBQyxHQUFJLENBQUMsQ0FBQyxBQUFDLENBQUM7S0FDWixDQUFDLENBQUM7O0FBRUgsUUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFTLENBQUMsRUFBWTtVQUFWLENBQUMsZ0NBQUcsSUFBSTs7QUFDekIsVUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO0FBQUUsZUFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO09BQUU7QUFDckMsT0FBQyxDQUFDLENBQUMsR0FBSSxDQUFDLENBQUMsQUFBQyxDQUFDO0tBQ1osQ0FBQyxDQUFDOztBQUVILFFBQUksQ0FBQyxJQUFJLENBQUMsVUFBUyxDQUFDLEVBQVk7VUFB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Q0FBQyxDQUFDOztBQUV0RCxVQUFFLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUNsQixJQUFJLENBQUMsVUFBQyxDQUFDLEVBQUs7QUFBRSxpQkFBTyxNQUFLLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQUUsQ0FBQyxDQUN2QyxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQUMsQ0FBQyxFQUFLO0FBQUUsaUJBQU8sTUFBSyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUFFLENBQUMsQ0FDaEQsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FDYixJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUNiLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxNQUFNLENBQUMsQ0FBQzs7QUFFL0IsWUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFO0FBQUUsWUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUFFO09BQzdDOzs7O1NBbk5HLEtBQUs7R0FBUyxLQUFLOztBQXNOekIsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFDLENBQ3BDLEdBQUcsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQ25DLE9BQU8sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFDcEMsV0FBVyxFQUFFLFNBQVMsQ0FDdkIsQ0FBQyxDQUFDOztBQUVILFNBQVMsT0FBTyxHQUFHO0FBQUUsU0FBTyxJQUFJLEtBQUssRUFBRSxDQUFDO0NBQUU7QUFDMUMsT0FBTyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7O0FBRXRCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDIiwiZmlsZSI6ImVzNi9oZWxwZXJzL3pvb21lci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIHsgdW5pcXVlSWQsIGFjY2Vzc29ycyB9ID0gcmVxdWlyZSgnLi4vaGVscGVycy91dGlscycpO1xudmFyIHsgTGF5ZXIgfSA9IHJlcXVpcmUoJy4uL2NvcmUvbGF5ZXInKTtcblxuY2xhc3MgTGFiZWwgZXh0ZW5kcyBMYXllciB7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgIHR5cGU6ICdsYWJlbCcsXG4gICAgICAvLyBleHBvc2UgdG8gYWxsb3cgdHdlYWtpbmcgdmVydGljYWwgYWxpZ25tZW50IGZvciBkZXNpZ24gYWRqdXN0bWVudHNcbiAgICAgIHZlcnRpY2FsQWxpZ25tZW50OiB7IHRvcDogJzFlbScsIG1pZGRsZTogJzAuNWVtJywgYm90dG9tOiAnMCcgfVxuICAgIH07XG5cbiAgICB0aGlzLnBhcmFtcyhkZWZhdWx0cyk7XG5cbiAgICAvLyBkYXRhIGFjY2Vzc29yc1xuICAgIHRoaXMueShmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuICtkLnkgfHwgMDsgfVxuICAgICAgZC55ID0gKCt2KTtcbiAgICB9KTtcblxuICAgIHRoaXMueChmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuICtkLnggfHwgMDsgfVxuICAgICAgZC54ID0gKCt2KTtcbiAgICB9KTtcblxuICAgIHRoaXMudGV4dChmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuIChkLnRleHQgKyAnJyk7IH1cbiAgICAgIGQudGV4dCA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5iZ0NvbG9yKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gZC5iZ0NvbG9yICsgJyc7IH1cbiAgICAgIGQuYmdDb2xvciA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgLy8gdGhlIGZvbGxvd2luZyBjYW4gYWxzbyBiZSBzZXR0ZWQgYXMgZ2xvYmFsIHBhcmFtc1xuICAgIC8vIHdoaWNoIGFyZSBhY3RpbmcgYXMgZGVmYXVsdCB2YWx1ZXNcbiAgICB0aGlzLndpZHRoKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gK2Qud2lkdGg7IH1cbiAgICAgIGQud2lkdGggPSAoK3YpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5oZWlnaHQoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSB7IHJldHVybiArZC5oZWlnaHQ7IH1cbiAgICAgIGQuaGVpZ2h0ID0gKCt2KTtcbiAgICB9KTtcblxuICAgIHRoaXMuY29sb3IoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSB7IHJldHVybiBkLmNvbG9yIHx8wqAnIzAwMDAwMCc7IH1cbiAgICAgIGQuY29sb3IgPSAodiArICcnKTtcbiAgICB9KTtcblxuICAgIC8vICdsZWZ0JywgJ2NlbnRlcicsICd0b3AnXG4gICAgdGhpcy5hbGlnbihmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuIGQuYWxpZ24gfHzCoCdsZWZ0JzsgfVxuICAgICAgZC5hbGlnbiA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgLy8gJ3RvcCcsICdtaWRkbGUnLCAnYm90dG9tJ1xuICAgIHRoaXMudmFsaWduKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gZC52YWxpZ24gfHzCoCd0b3AnOyB9XG4gICAgICBkLnZhbGlnbiA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5tYXJnaW4oeyB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAsIGxlZnQ6IDAgfSk7XG4gIH1cblxuICB4Wm9vbShmYWN0b3IpIHtcbiAgICB0aGlzLmRyYXcoKTtcbiAgfVxuXG4gIHVwZGF0ZShkYXRhKSB7XG4gICAgc3VwZXIudXBkYXRlKGRhdGEpO1xuXG4gICAgdGhpcy5pdGVtcyA9IHRoaXMuZy5zZWxlY3RBbGwoJy4nICsgdGhpcy5wYXJhbSgndW5pdENsYXNzJykpXG4gICAgICAuZGF0YSh0aGlzLmRhdGEoKSwgdGhpcy5zb3J0SW5kZXgoKSk7XG5cbiAgICB2YXIgc2VsID0gdGhpcy5pdGVtcy5lbnRlcigpXG4gICAgICAuYXBwZW5kKCdnJylcbiAgICAgIC5jbGFzc2VkKCdpdGVtJywgdHJ1ZSlcbiAgICAgIC5jbGFzc2VkKHRoaXMucGFyYW0oJ3VuaXRDbGFzcycpLCB0cnVlKTtcblxuICAgIHNlbC5hcHBlbmQoJ3JlY3QnKVxuICAgICAgLmF0dHIoJ2NsYXNzJywgJ2JvdW5kaW5nLWJveCcpXG4gICAgICAuYXR0cignZmlsbCcsICd0cmFuc3BhcmVudCcpO1xuXG4gICAgc2VsLmFwcGVuZCgndGV4dCcpXG4gICAgIC5hdHRyKCdjbGFzcycsICd0ZXh0Jyk7XG5cbiAgICB0aGlzLml0ZW1zLmV4aXQoKS5yZW1vdmUoKTtcbiAgfVxuXG4gIGRyYXcoZWwgPSBudWxsKSB7XG4gICAgZWwgPSBlbCB8fCB0aGlzLml0ZW1zO1xuXG4gICAgdmFyIF94U2NhbGUgPSB0aGlzLmJhc2UueFNjYWxlO1xuICAgIHZhciBfeVNjYWxlID0gdGhpcy55U2NhbGU7XG5cbiAgICB2YXIgX3cgPSB0aGlzLndpZHRoKCk7XG4gICAgdmFyIF9oID0gdGhpcy5oZWlnaHQoKTtcbiAgICB2YXIgX3ggPSB0aGlzLngoKTtcbiAgICB2YXIgX3kgPSB0aGlzLnkoKTtcbiAgICB2YXIgX2FsaWduICA9IHRoaXMuYWxpZ24oKTtcbiAgICB2YXIgX3ZhbGlnbiA9IHRoaXMudmFsaWduKCk7XG4gICAgdmFyIF9tYXJnaW4gPSB0aGlzLm1hcmdpbigpO1xuICAgIHZhciBfdmVydGljYWxBbGlnbm1lbnQgPSB0aGlzLnBhcmFtcygpLnZlcnRpY2FsQWxpZ25tZW50O1xuICAgIHZhciBtaW5Eb21haW4gPSBfeFNjYWxlLmRvbWFpbigpWzBdO1xuXG4gICAgLy8gc2NhbGVzIGZvciBib3VuZGluZyBib3ggcG9zaXRpb25cbiAgICB2YXIgdyA9IChkKSA9PiB7XG4gICAgICB2YXIgd2lkdGggPSBfeFNjYWxlKG1pbkRvbWFpbiArIF93KGQpKTtcbiAgICAgIHJldHVybiB3aWR0aCA8IDAgPyAwIDogd2lkdGg7XG4gICAgfTtcblxuICAgIHZhciB4ID0gKGQpID0+IHtcbiAgICAgIHJldHVybiBfeFNjYWxlKF94KGQpKTtcbiAgICB9O1xuXG4gICAgdmFyIGggPSAoZCkgPT4ge1xuICAgICAgcmV0dXJuICh0aGlzLnBhcmFtKCdoZWlnaHQnKSAtIF95U2NhbGUoX2goZCkpKSB8fCB0aGlzLnBhcmFtKCdoZWlnaHQnKTtcbiAgICB9O1xuXG4gICAgdmFyIHkgPSAoZCkgPT4ge1xuICAgICAgcmV0dXJuIChfeVNjYWxlKF95KGQpKSAtIGgoZCkpIHx8IDA7XG4gICAgfTtcblxuICAgIC8vIHNjYWxlcyBmb3IgdGV4dC1wb3NpdGlvblxuICAgIHZhciB0eCA9IChkKSA9PiB7XG4gICAgICB2YXIgcmV0O1xuICAgICAgc3dpdGNoIChfYWxpZ24oZCkpIHtcbiAgICAgICAgY2FzZSAnbGVmdCc6XG4gICAgICAgICAgcmV0ID0geChkKSArIHBhcnNlSW50KF9tYXJnaW4oKS5sZWZ0LCAxMCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2NlbnRlcic6XG4gICAgICAgICAgcmV0ID0geChkKSArICh3KGQpIC8gMik7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3JpZ2h0JzpcbiAgICAgICAgICByZXQgPSB4KGQpICsgdyhkKSAtIHBhcnNlSW50KF9tYXJnaW4oKS5yaWdodCwgMTApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmV0O1xuICAgIH07XG5cbiAgICB2YXIgYW5jaG9yID0gKGQpID0+IHtcbiAgICAgIHZhciByZXQ7XG4gICAgICBzd2l0Y2ggKF9hbGlnbihkKSkge1xuICAgICAgICBjYXNlICdsZWZ0JzpcbiAgICAgICAgICByZXQgPSAnc3RhcnQnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdjZW50ZXInOlxuICAgICAgICAgIHJldCA9ICdtaWRkbGUnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdyaWdodCc6XG4gICAgICAgICAgcmV0ID0gJ2VuZCc7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcblxuICAgIHZhciB0eSA9IChkKSA9PiB7XG4gICAgICB2YXIgcmV0O1xuICAgICAgc3dpdGNoIChfdmFsaWduKGQpKSB7XG4gICAgICAgIGNhc2UgJ3RvcCc6XG4gICAgICAgICAgcmV0ID0geShkKSArIHBhcnNlSW50KF9tYXJnaW4oKS50b3AsIDEwKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnbWlkZGxlJzpcbiAgICAgICAgICByZXQgPSB5KGQpICsgKGgoZCkgLyAyKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnYm90dG9tJzpcbiAgICAgICAgICByZXQgPSB5KGQpICsgaChkKSAtIHBhcnNlSW50KF9tYXJnaW4oKS5ib3R0b20sIDEwKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuXG4gICAgLy8gYmFzZWQgb24gc21hbGwgbWFudWFsIHRlc3RpbmcgLSBjYW4gcHJvYmFibHkgYmUgaW1wcm92ZWRcbiAgICB2YXIgZHkgPSAoZCkgPT4ge1xuICAgICAgdmFyIHJldDtcbiAgICAgIHN3aXRjaCAoX3ZhbGlnbihkKSkge1xuICAgICAgICBjYXNlICd0b3AnOlxuICAgICAgICAgIHJldCA9IF92ZXJ0aWNhbEFsaWdubWVudC50b3A7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ21pZGRsZSc6XG4gICAgICAgICAgcmV0ID0gX3ZlcnRpY2FsQWxpZ25tZW50Lm1pZGRsZTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnYm90dG9tJzpcbiAgICAgICAgICByZXQgPSBfdmVydGljYWxBbGlnbm1lbnQuYm90dG9tO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmV0O1xuICAgIH07XG5cbiAgICBlbC5zZWxlY3RBbGwoJy5ib3VuZGluZy1ib3gnKVxuICAgICAgLmF0dHIoJ3gnLCB4KVxuICAgICAgLmF0dHIoJ3knLCB5KVxuICAgICAgLmF0dHIoJ3dpZHRoJywgdylcbiAgICAgIC5hdHRyKCdoZWlnaHQnLCBoKVxuICAgICAgLmF0dHIoJ2ZpbGwnLCAoZCkgPT4geyByZXR1cm4gdGhpcy5iZ0NvbG9yKCkoZCk7IH0pO1xuXG4gICAgZWwuc2VsZWN0QWxsKCcudGV4dCcpXG4gICAgICAudGV4dCgoZCkgPT4geyByZXR1cm4gdGhpcy50ZXh0KCkoZCk7IH0pXG4gICAgICAuYXR0cignZmlsbCcsIChkKSA9PiB7IHJldHVybiB0aGlzLmNvbG9yKCkoZCk7IH0pXG4gICAgICAuYXR0cigneCcsIHR4KVxuICAgICAgLmF0dHIoJ3knLCB0eSlcbiAgICAgIC5hdHRyKCdkeScsIGR5KVxuICAgICAgLmF0dHIoJ3RleHQtYW5jaG9yJywgYW5jaG9yKTtcblxuICAgIGlmICghIXRoaXMuZWFjaCgpKSB7IGVsLmVhY2godGhpcy5lYWNoKCkpOyB9XG4gIH1cbn1cblxuYWNjZXNzb3JzLmdldEZ1bmN0aW9uKExhYmVsLnByb3RvdHlwZSxbXG4gICd4JywgJ3knLCAnd2lkdGgnLCAnaGVpZ2h0JywgJ3RleHQnLFxuICAnY29sb3InLCAnYWxpZ24nLCAndmFsaWduJywgJ21hcmdpbicsXG4gICdzb3J0SW5kZXgnLCAnYmdDb2xvcidcbl0pO1xuXG5mdW5jdGlvbiBmYWN0b3J5KCkgeyByZXR1cm4gbmV3IExhYmVsKCk7IH1cbmZhY3RvcnkuTGFiZWwgPSBMYWJlbDtcblxubW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5O1xuIl19