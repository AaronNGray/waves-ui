"use strict";

var _classCallCheck = require("babel-runtime/helpers/class-call-check")["default"];

var _inherits = require("babel-runtime/helpers/inherits")["default"];

var _get = require("babel-runtime/helpers/get")["default"];

var _createClass = require("babel-runtime/helpers/create-class")["default"];

var _core = require("babel-runtime/core-js")["default"];

var _require = require("../helpers/utils");

var uniqueId = _require.uniqueId;
var accessors = _require.accessors;

var _require2 = require("../core/layer");

var Layer = _require2.Layer;

var Label = (function (_Layer) {
  function Label() {
    _classCallCheck(this, Label);

    _get(_core.Object.getPrototypeOf(Label.prototype), "constructor", this).call(this);

    var defaults = {
      type: "label",
      // expose to allow tweaking vertical alignment for design adjustments
      verticalAlignment: { top: "1em", middle: "0.5em", bottom: "0" }
    };

    this.params(defaults);

    // data accessors
    this.y(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.y || 0;
      }
      d.y = +v;
    });

    this.x(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.x || 0;
      }
      d.x = +v;
    });

    this.text(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.text + "";
      }
      d.text = v + "";
    });

    this.bgColor(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.bgColor + "";
      }
      d.bgColor = v + "";
    });

    // the following can also be setted as global params
    // which are acting as default values
    this.width(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.width;
      }
      d.width = +v;
    });

    this.height(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return +d.height;
      }
      d.height = +v;
    });

    this.color(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.color || "#000000";
      }
      d.color = v + "";
    });

    // 'left', 'center', 'top'
    this.align(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.align || "left";
      }
      d.align = v + "";
    });

    // 'top', 'middle', 'bottom'
    this.valign(function (d) {
      var v = arguments[1] === undefined ? null : arguments[1];

      if (v === null) {
        return d.valign || "top";
      }
      d.valign = v + "";
    });

    this.margin({ top: 0, right: 0, bottom: 0, left: 0 });
  }

  _inherits(Label, _Layer);

  _createClass(Label, {
    xZoom: {
      value: function xZoom(factor) {
        this.draw();
      }
    },
    update: {
      value: function update(data) {
        _get(_core.Object.getPrototypeOf(Label.prototype), "update", this).call(this, data);

        this.items = this.g.selectAll("." + this.param("unitClass")).data(this.data());

        var sel = this.items.enter().append("g").classed("item", true).classed(this.param("unitClass"), true);

        sel.append("rect").attr("class", "bounding-box").attr("fill", "transparent");

        sel.append("text").attr("class", "text");

        this.items.exit().remove();
      }
    },
    draw: {
      value: function draw() {
        var _this = this;

        var el = arguments[0] === undefined ? null : arguments[0];

        el = el || this.items;

        var _xScale = this.base.xScale;
        var _yScale = this.yScale;

        var _w = this.width();
        var _h = this.height();
        var _x = this.x();
        var _y = this.y();
        var _align = this.align();
        var _valign = this.valign();
        var _margin = this.margin();
        var _verticalAlignment = this.params().verticalAlignment;
        var minDomain = _xScale.domain()[0];

        // scales for bounding box position
        var w = function (d) {
          var width = _xScale(minDomain + _w(d));
          return width < 0 ? 0 : width;
        };

        var x = function (d) {
          return _xScale(_x(d));
        };

        var h = function (d) {
          return _this.param("height") - _yScale(_h(d)) || _this.param("height");
        };

        var y = function (d) {
          return _yScale(_y(d)) - h(d) || 0;
        };

        // scales for text-position
        var tx = function (d) {
          var ret;
          switch (_align(d)) {
            case "left":
              ret = x(d) + parseInt(_margin().left, 10);
              break;
            case "center":
              ret = x(d) + w(d) / 2;
              break;
            case "right":
              ret = x(d) + w(d) - parseInt(_margin().right, 10);
              break;
          }

          return ret;
        };

        var anchor = function (d) {
          var ret;
          switch (_align(d)) {
            case "left":
              ret = "start";
              break;
            case "center":
              ret = "middle";
              break;
            case "right":
              ret = "end";
              break;
          }

          return ret;
        };

        var ty = function (d) {
          var ret;
          switch (_valign(d)) {
            case "top":
              ret = y(d) + parseInt(_margin().top, 10);
              break;
            case "middle":
              ret = y(d) + h(d) / 2;
              break;
            case "bottom":
              ret = y(d) + h(d) - parseInt(_margin().bottom, 10);
              break;
          }

          return ret;
        };

        // based on small manual testing - can probably be improved
        var dy = function (d) {
          var ret;
          switch (_valign(d)) {
            case "top":
              ret = _verticalAlignment.top;
              break;
            case "middle":
              ret = _verticalAlignment.middle;
              break;
            case "bottom":
              ret = _verticalAlignment.bottom;
              break;
          }

          return ret;
        };

        el.selectAll(".bounding-box").attr("x", x).attr("y", y).attr("width", w).attr("height", h).attr("fill", function (d) {
          return _this.bgColor()(d);
        });

        el.selectAll(".text").text(function (d) {
          return _this.text()(d);
        }).attr("fill", function (d) {
          return _this.color()(d);
        }).attr("x", tx).attr("y", ty).attr("dy", dy).attr("text-anchor", anchor);

        if (!!this.each()) {
          el.each(this.each());
        }
      }
    }
  });

  return Label;
})(Layer);

accessors.getFunction(Label.prototype, ["x", "y", "width", "height", "text", "color", "align", "valign", "margin", "sortIndex", "bgColor"]);

function factory() {
  return new Label();
}
factory.Label = Label;

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVzNi9oZWxwZXJzL3pvb21lci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7ZUFFOEIsT0FBTyxDQUFDLGtCQUFrQixDQUFDOztJQUFuRCxRQUFRLFlBQVIsUUFBUTtJQUFFLFNBQVMsWUFBVCxTQUFTOztnQkFDVCxPQUFPLENBQUMsZUFBZSxDQUFDOztJQUFsQyxLQUFLLGFBQUwsS0FBSzs7SUFFTCxLQUFLO0FBRUUsV0FGUCxLQUFLLEdBRUs7MEJBRlYsS0FBSzs7QUFHUCxxQ0FIRSxLQUFLLDZDQUdDOztBQUVSLFFBQUksUUFBUSxHQUFHO0FBQ2IsVUFBSSxFQUFFLE9BQU87O0FBRWIsdUJBQWlCLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRTtLQUNoRSxDQUFDOztBQUVGLFFBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7OztBQUd0QixRQUFJLENBQUMsQ0FBQyxDQUFDLFVBQVMsQ0FBQyxFQUFZO1VBQVYsQ0FBQyxnQ0FBRyxJQUFJOztBQUN6QixVQUFJLENBQUMsS0FBSyxJQUFJLEVBQUU7QUFBRSxlQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7T0FBRTtBQUNyQyxPQUFDLENBQUMsQ0FBQyxHQUFJLENBQUMsQ0FBQyxBQUFDLENBQUM7S0FDWixDQUFDLENBQUM7O0FBRUgsUUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFTLENBQUMsRUFBWTtVQUFWLENBQUMsZ0NBQUcsSUFBSTs7QUFDekIsVUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO0FBQUUsZUFBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO09BQUU7QUFDckMsT0FBQyxDQUFDLENBQUMsR0FBSSxDQUFDLENBQUMsQUFBQyxDQUFDO0tBQ1osQ0FBQyxDQUFDOztBQUVILFFBQUksQ0FBQyxJQUFJLENBQUMsVUFBUyxDQUFDLEVBQVk7VUFB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QyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQ2xCLElBQUksQ0FBQyxVQUFDLENBQUMsRUFBSztBQUFFLGlCQUFPLE1BQUssSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FBRSxDQUFDLENBQ3ZDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBQyxDQUFDLEVBQUs7QUFBRSxpQkFBTyxNQUFLLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQUUsQ0FBQyxDQUNoRCxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUNiLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQ2IsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FDZCxJQUFJLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDOztBQUUvQixZQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUU7QUFBRSxZQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQUU7T0FDN0M7Ozs7U0FuTkcsS0FBSztHQUFTLEtBQUs7O0FBc056QixTQUFTLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUMsQ0FDcEMsR0FBRyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFDbkMsT0FBTyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUNwQyxXQUFXLEVBQUUsU0FBUyxDQUN2QixDQUFDLENBQUM7O0FBRUgsU0FBUyxPQUFPLEdBQUc7QUFBRSxTQUFPLElBQUksS0FBSyxFQUFFLENBQUM7Q0FBRTtBQUMxQyxPQUFPLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQzs7QUFFdEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMiLCJmaWxlIjoiZXM2L2hlbHBlcnMvem9vbWVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgeyB1bmlxdWVJZCwgYWNjZXNzb3JzIH0gPSByZXF1aXJlKCcuLi9oZWxwZXJzL3V0aWxzJyk7XG52YXIgeyBMYXllciB9ID0gcmVxdWlyZSgnLi4vY29yZS9sYXllcicpO1xuXG5jbGFzcyBMYWJlbCBleHRlbmRzIExheWVyIHtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgdHlwZTogJ2xhYmVsJyxcbiAgICAgIC8vIGV4cG9zZSB0byBhbGxvdyB0d2Vha2luZyB2ZXJ0aWNhbCBhbGlnbm1lbnQgZm9yIGRlc2lnbiBhZGp1c3RtZW50c1xuICAgICAgdmVydGljYWxBbGlnbm1lbnQ6IHsgdG9wOiAnMWVtJywgbWlkZGxlOiAnMC41ZW0nLCBib3R0b206ICcwJyB9XG4gICAgfTtcblxuICAgIHRoaXMucGFyYW1zKGRlZmF1bHRzKTtcblxuICAgIC8vIGRhdGEgYWNjZXNzb3JzXG4gICAgdGhpcy55KGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gK2QueSB8fCAwOyB9XG4gICAgICBkLnkgPSAoK3YpO1xuICAgIH0pO1xuXG4gICAgdGhpcy54KGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gK2QueCB8fCAwOyB9XG4gICAgICBkLnggPSAoK3YpO1xuICAgIH0pO1xuXG4gICAgdGhpcy50ZXh0KGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gKGQudGV4dCArICcnKTsgfVxuICAgICAgZC50ZXh0ID0gKHYgKyAnJyk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmJnQ29sb3IoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSB7IHJldHVybiBkLmJnQ29sb3IgKyAnJzsgfVxuICAgICAgZC5iZ0NvbG9yID0gKHYgKyAnJyk7XG4gICAgfSk7XG5cbiAgICAvLyB0aGUgZm9sbG93aW5nIGNhbiBhbHNvIGJlIHNldHRlZCBhcyBnbG9iYWwgcGFyYW1zXG4gICAgLy8gd2hpY2ggYXJlIGFjdGluZyBhcyBkZWZhdWx0IHZhbHVlc1xuICAgIHRoaXMud2lkdGgoZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSB7IHJldHVybiArZC53aWR0aDsgfVxuICAgICAgZC53aWR0aCA9ICgrdik7XG4gICAgfSk7XG5cbiAgICB0aGlzLmhlaWdodChmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuICtkLmhlaWdodDsgfVxuICAgICAgZC5oZWlnaHQgPSAoK3YpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5jb2xvcihmdW5jdGlvbihkLCB2ID0gbnVsbCkge1xuICAgICAgaWYgKHYgPT09IG51bGwpIHsgcmV0dXJuIGQuY29sb3IgfHzCoCcjMDAwMDAwJzsgfVxuICAgICAgZC5jb2xvciA9ICh2ICsgJycpO1xuICAgIH0pO1xuXG4gICAgLy8gJ2xlZnQnLCAnY2VudGVyJywgJ3RvcCdcbiAgICB0aGlzLmFsaWduKGZ1bmN0aW9uKGQsIHYgPSBudWxsKSB7XG4gICAgICBpZiAodiA9PT0gbnVsbCkgeyByZXR1cm4gZC5hbGlnbiB8fMKgJ2xlZnQnOyB9XG4gICAgICBkLmFsaWduID0gKHYgKyAnJyk7XG4gICAgfSk7XG5cbiAgICAvLyAndG9wJywgJ21pZGRsZScsICdib3R0b20nXG4gICAgdGhpcy52YWxpZ24oZnVuY3Rpb24oZCwgdiA9IG51bGwpIHtcbiAgICAgIGlmICh2ID09PSBudWxsKSB7IHJldHVybiBkLnZhbGlnbiB8fMKgJ3RvcCc7IH1cbiAgICAgIGQudmFsaWduID0gKHYgKyAnJyk7XG4gICAgfSk7XG5cbiAgICB0aGlzLm1hcmdpbih7IHRvcDogMCwgcmlnaHQ6IDAsIGJvdHRvbTogMCwgbGVmdDogMCB9KTtcbiAgfVxuXG4gIHhab29tKGZhY3Rvcikge1xuICAgIHRoaXMuZHJhdygpO1xuICB9XG5cbiAgdXBkYXRlKGRhdGEpIHtcbiAgICBzdXBlci51cGRhdGUoZGF0YSk7XG5cbiAgICB0aGlzLml0ZW1zID0gdGhpcy5nLnNlbGVjdEFsbCgnLicgKyB0aGlzLnBhcmFtKCd1bml0Q2xhc3MnKSlcbiAgICAgIC5kYXRhKHRoaXMuZGF0YSgpKTtcblxuICAgIHZhciBzZWwgPSB0aGlzLml0ZW1zLmVudGVyKClcbiAgICAgIC5hcHBlbmQoJ2cnKVxuICAgICAgLmNsYXNzZWQoJ2l0ZW0nLCB0cnVlKVxuICAgICAgLmNsYXNzZWQodGhpcy5wYXJhbSgndW5pdENsYXNzJyksIHRydWUpO1xuXG4gICAgc2VsLmFwcGVuZCgncmVjdCcpXG4gICAgICAuYXR0cignY2xhc3MnLCAnYm91bmRpbmctYm94JylcbiAgICAgIC5hdHRyKCdmaWxsJywgJ3RyYW5zcGFyZW50Jyk7XG5cbiAgICBzZWwuYXBwZW5kKCd0ZXh0JylcbiAgICAgLmF0dHIoJ2NsYXNzJywgJ3RleHQnKTtcblxuICAgIHRoaXMuaXRlbXMuZXhpdCgpLnJlbW92ZSgpO1xuICB9XG5cbiAgZHJhdyhlbCA9IG51bGwpIHtcbiAgICBlbCA9IGVsIHx8IHRoaXMuaXRlbXM7XG5cbiAgICB2YXIgX3hTY2FsZSA9IHRoaXMuYmFzZS54U2NhbGU7XG4gICAgdmFyIF95U2NhbGUgPSB0aGlzLnlTY2FsZTtcblxuICAgIHZhciBfdyA9IHRoaXMud2lkdGgoKTtcbiAgICB2YXIgX2ggPSB0aGlzLmhlaWdodCgpO1xuICAgIHZhciBfeCA9IHRoaXMueCgpO1xuICAgIHZhciBfeSA9IHRoaXMueSgpO1xuICAgIHZhciBfYWxpZ24gID0gdGhpcy5hbGlnbigpO1xuICAgIHZhciBfdmFsaWduID0gdGhpcy52YWxpZ24oKTtcbiAgICB2YXIgX21hcmdpbiA9IHRoaXMubWFyZ2luKCk7XG4gICAgdmFyIF92ZXJ0aWNhbEFsaWdubWVudCA9IHRoaXMucGFyYW1zKCkudmVydGljYWxBbGlnbm1lbnQ7XG4gICAgdmFyIG1pbkRvbWFpbiA9IF94U2NhbGUuZG9tYWluKClbMF07XG5cbiAgICAvLyBzY2FsZXMgZm9yIGJvdW5kaW5nIGJveCBwb3NpdGlvblxuICAgIHZhciB3ID0gKGQpID0+IHtcbiAgICAgIHZhciB3aWR0aCA9IF94U2NhbGUobWluRG9tYWluICsgX3coZCkpO1xuICAgICAgcmV0dXJuIHdpZHRoIDwgMCA/IDAgOiB3aWR0aDtcbiAgICB9O1xuXG4gICAgdmFyIHggPSAoZCkgPT4ge1xuICAgICAgcmV0dXJuIF94U2NhbGUoX3goZCkpO1xuICAgIH07XG5cbiAgICB2YXIgaCA9IChkKSA9PiB7XG4gICAgICByZXR1cm4gKHRoaXMucGFyYW0oJ2hlaWdodCcpIC0gX3lTY2FsZShfaChkKSkpIHx8IHRoaXMucGFyYW0oJ2hlaWdodCcpO1xuICAgIH07XG5cbiAgICB2YXIgeSA9IChkKSA9PiB7XG4gICAgICByZXR1cm4gKF95U2NhbGUoX3koZCkpIC0gaChkKSkgfHwgMDtcbiAgICB9O1xuXG4gICAgLy8gc2NhbGVzIGZvciB0ZXh0LXBvc2l0aW9uXG4gICAgdmFyIHR4ID0gKGQpID0+IHtcbiAgICAgIHZhciByZXQ7XG4gICAgICBzd2l0Y2ggKF9hbGlnbihkKSkge1xuICAgICAgICBjYXNlICdsZWZ0JzpcbiAgICAgICAgICByZXQgPSB4KGQpICsgcGFyc2VJbnQoX21hcmdpbigpLmxlZnQsIDEwKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnY2VudGVyJzpcbiAgICAgICAgICByZXQgPSB4KGQpICsgKHcoZCkgLyAyKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAncmlnaHQnOlxuICAgICAgICAgIHJldCA9IHgoZCkgKyB3KGQpIC0gcGFyc2VJbnQoX21hcmdpbigpLnJpZ2h0LCAxMCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcblxuICAgIHZhciBhbmNob3IgPSAoZCkgPT4ge1xuICAgICAgdmFyIHJldDtcbiAgICAgIHN3aXRjaCAoX2FsaWduKGQpKSB7XG4gICAgICAgIGNhc2UgJ2xlZnQnOlxuICAgICAgICAgIHJldCA9ICdzdGFydCc7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2NlbnRlcic6XG4gICAgICAgICAgcmV0ID0gJ21pZGRsZSc7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3JpZ2h0JzpcbiAgICAgICAgICByZXQgPSAnZW5kJztcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJldDtcbiAgICB9O1xuXG4gICAgdmFyIHR5ID0gKGQpID0+IHtcbiAgICAgIHZhciByZXQ7XG4gICAgICBzd2l0Y2ggKF92YWxpZ24oZCkpIHtcbiAgICAgICAgY2FzZSAndG9wJzpcbiAgICAgICAgICByZXQgPSB5KGQpICsgcGFyc2VJbnQoX21hcmdpbigpLnRvcCwgMTApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdtaWRkbGUnOlxuICAgICAgICAgIHJldCA9IHkoZCkgKyAoaChkKSAvIDIpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdib3R0b20nOlxuICAgICAgICAgIHJldCA9IHkoZCkgKyBoKGQpIC0gcGFyc2VJbnQoX21hcmdpbigpLmJvdHRvbSwgMTApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmV0O1xuICAgIH07XG5cbiAgICAvLyBiYXNlZCBvbiBzbWFsbCBtYW51YWwgdGVzdGluZyAtIGNhbiBwcm9iYWJseSBiZSBpbXByb3ZlZFxuICAgIHZhciBkeSA9IChkKSA9PiB7XG4gICAgICB2YXIgcmV0O1xuICAgICAgc3dpdGNoIChfdmFsaWduKGQpKSB7XG4gICAgICAgIGNhc2UgJ3RvcCc6XG4gICAgICAgICAgcmV0ID0gX3ZlcnRpY2FsQWxpZ25tZW50LnRvcDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnbWlkZGxlJzpcbiAgICAgICAgICByZXQgPSBfdmVydGljYWxBbGlnbm1lbnQubWlkZGxlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdib3R0b20nOlxuICAgICAgICAgIHJldCA9IF92ZXJ0aWNhbEFsaWdubWVudC5ib3R0b207XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXQ7XG4gICAgfTtcblxuICAgIGVsLnNlbGVjdEFsbCgnLmJvdW5kaW5nLWJveCcpXG4gICAgICAuYXR0cigneCcsIHgpXG4gICAgICAuYXR0cigneScsIHkpXG4gICAgICAuYXR0cignd2lkdGgnLCB3KVxuICAgICAgLmF0dHIoJ2hlaWdodCcsIGgpXG4gICAgICAuYXR0cignZmlsbCcsIChkKSA9PiB7IHJldHVybiB0aGlzLmJnQ29sb3IoKShkKTsgfSk7XG5cbiAgICBlbC5zZWxlY3RBbGwoJy50ZXh0JylcbiAgICAgIC50ZXh0KChkKSA9PiB7IHJldHVybiB0aGlzLnRleHQoKShkKTsgfSlcbiAgICAgIC5hdHRyKCdmaWxsJywgKGQpID0+IHsgcmV0dXJuIHRoaXMuY29sb3IoKShkKTsgfSlcbiAgICAgIC5hdHRyKCd4JywgdHgpXG4gICAgICAuYXR0cigneScsIHR5KVxuICAgICAgLmF0dHIoJ2R5JywgZHkpXG4gICAgICAuYXR0cigndGV4dC1hbmNob3InLCBhbmNob3IpO1xuXG4gICAgaWYgKCEhdGhpcy5lYWNoKCkpIHsgZWwuZWFjaCh0aGlzLmVhY2goKSk7IH1cbiAgfVxufVxuXG5hY2Nlc3NvcnMuZ2V0RnVuY3Rpb24oTGFiZWwucHJvdG90eXBlLFtcbiAgJ3gnLCAneScsICd3aWR0aCcsICdoZWlnaHQnLCAndGV4dCcsXG4gICdjb2xvcicsICdhbGlnbicsICd2YWxpZ24nLCAnbWFyZ2luJyxcbiAgJ3NvcnRJbmRleCcsICdiZ0NvbG9yJ1xuXSk7XG5cbmZ1bmN0aW9uIGZhY3RvcnkoKSB7IHJldHVybiBuZXcgTGFiZWwoKTsgfVxuZmFjdG9yeS5MYWJlbCA9IExhYmVsO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZhY3Rvcnk7XG4iXX0=