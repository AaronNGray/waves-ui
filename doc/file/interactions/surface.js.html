<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">interactions/surface.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/wavesjs/ui" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/interactions/event-source.js~EventSource.html">EventSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/interactions/keyboard.js~Keyboard.html">Keyboard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/interactions/surface.js~Surface.html">Surface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/interactions/wave-event.js~WaveEvent.html">WaveEvent</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">interactions/surface.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import EventSource from &apos;./event-source&apos;;
import WaveEvent from &apos;./wave-event&apos;;


const body = window.document.body;

/**
 * `Surface` normalizes mouse user interactions with the timeline upon the DOM container element of `Track` instances.
 * As soon as a `track` is added to a `timeline`, its attached `Surface` instance will emit the mouse events.
 */
export default class Surface extends EventSource {
  /**
   * @param {DOMElement} el - the DOM element to monitor
   */
  constructor(el /*, padding of the current surface @TODO */) {
    super(el);

    this.sourceName = &apos;surface&apos;;
    // this.isMouseDown = false;
    this.mouseDownEvent = null;
    this.lastEvent = null;
  }

  /**
   * Factory method for `Event` class
   */
  _createEvent(type, e) {
    const event = new WaveEvent(this.sourceName, type, e);

    const pos = this._getRelativePosition(e);
    event.x = pos.x;
    event.y = pos.y;
    this.dx = null;
    this.dy = null;
    this.area = null; // @TODO rename

    return event;
  }

  /**
   * @param {Event} e - raw event from listener
   * @return {Object} The x, y coordinates coordinates relative to the surface element
   */
  _getRelativePosition(e) {
    // @TODO: should be able to ignore padding
    let x = 0;
    let y = 0;
    const clientRect = this.el.getBoundingClientRect();
    const scrollLeft = document.body.scrollLeft + document.documentElement.scrollLeft;
    const scrollTop  = document.body.scrollTop + document.documentElement.scrollTop;

    // Adapted from http://www.quirksmode.org/js/events_properties.html#position
    if (e.pageX || e.pageY) {
      x = e.pageX;
      y = e.pageY;
    } else if (e.clientX || e.clientY) {
      // Normalize to pageX, pageY
      x = e.clientX + scrollLeft;
      y = e.clientY + scrollTop;
    }

    // clientRect refers to the client, not to the page
    x = x - (clientRect.left + scrollLeft);
    y = y - (clientRect.top  + scrollTop );

    // Should handle padding

    return { x, y };
  }

  _defineArea(e, mouseDownEvent, lastEvent) {
    if (!mouseDownEvent ||&#xA0;!lastEvent) { return; }
    e.dx = e.x - lastEvent.x;
    e.dy = e.y - lastEvent.y;

    const left = mouseDownEvent.x &lt; e.x ? mouseDownEvent.x : e.x;
    const top  = mouseDownEvent.y &lt; e.y ? mouseDownEvent.y : e.y;
    const width  = Math.abs(Math.round(e.x - mouseDownEvent.x));
    const height = Math.abs(Math.round(e.y - mouseDownEvent.y));

    e.area = { left, top, width, height };
  }

  /**
   * Keep this private to avoid double event binding
   * Main logic of the surface is here
   * Should be extended with needed events (mouseenter, mouseleave, wheel ...)
   */
  _bindEvents() {
    const onMouseDown = (e) =&gt; {
      // By removing the previous selection we prevent bypassing the mousemove events coming from SVG in Firefox.
      window.getSelection().removeAllRanges();
      const event = this._createEvent(&apos;mousedown&apos;, e);

      this.isMouseDown = true;
      this.mouseDownEvent = event;
      this.lastEvent = event;
      // Register mousemove and mouseup listeners on window
      window.addEventListener(&apos;mousemove&apos;, onMouseMove, false);
      window.addEventListener(&apos;mouseup&apos;, onMouseUp, false);

      this.emit(&apos;event&apos;, event);
    };

    const onMouseMove = (e) =&gt; {
      let event = this._createEvent(&apos;mousemove&apos;, e);
      this._defineArea(event, this.mouseDownEvent, this.lastEvent);
      // Update `lastEvent` for next call
      this.lastEvent = event;

      this.emit(&apos;event&apos;, event);
    };

    const onMouseUp = (e) =&gt; {
      let event = this._createEvent(&apos;mouseup&apos;, e);
      this._defineArea(event, this.mouseDownEvent, this.lastEvent);

      this.isMouseDown = false;
      this.mouseDownEvent = null;
      this.lastEvent = null;
      // Remove mousemove and mouseup listeners on window
      window.removeEventListener(&apos;mousemove&apos;, onMouseMove);
      window.removeEventListener(&apos;mouseup&apos;, onMouseUp);

      this.emit(&apos;event&apos;, event);
    };

    const onClick = (e) =&gt; {
      let event = this._createEvent(&apos;click&apos;, e);
      this.emit(&apos;event&apos;, event);
    };

    const onDblClick = (e) =&gt; {
      let event = this._createEvent(&apos;dblclick&apos;, e);
      this.emit(&apos;event&apos;, event);
    };

    const onMouseOver = (e) =&gt; {
      let event = this._createEvent(&apos;mouseover&apos;, e);
      this.emit(&apos;event&apos;, event);
    };

    const onMouseOut = (e) =&gt; {
      let event = this._createEvent(&apos;mouseout&apos;, e);
      this.emit(&apos;event&apos;, event);
    };

    // Bind callbacks
    this.el.addEventListener(&apos;mousedown&apos;, onMouseDown, false);
    this.el.addEventListener(&apos;click&apos;, onClick, false);
    this.el.addEventListener(&apos;dblclick&apos;, onDblClick, false);
    this.el.addEventListener(&apos;mouseover&apos;, onMouseOver, false);
    this.el.addEventListener(&apos;mouseout&apos;, onMouseOut, false);
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
